---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer';
import articlesData from '../../data/articles.json';

export async function getStaticPaths() {
  return articlesData.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;

function formatDate(dateString: string): string {
  return new Intl.DateTimeFormat('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(new Date(dateString));
}

// Encontrar artículos relacionados de la misma categoría
const relatedArticles = articlesData
  .filter(a => a.categorySlug === article.categorySlug && a.id !== article.id)
  .slice(0, 3);

// Convertir el contenido con saltos de línea a HTML
const contentHTML = article.content
  .split('\n\n')
  .map(paragraph => {
    if (paragraph.startsWith('##')) {
      return `<h2>${paragraph.replace('## ', '')}</h2>`;
    } else if (paragraph.startsWith('###')) {
      return `<h3>${paragraph.replace('### ', '')}</h3>`;
    } else if (paragraph.startsWith('**') && paragraph.endsWith('**')) {
      return `<p><strong>${paragraph.slice(2, -2)}</strong></p>`;
    } else {
      return `<p>${paragraph}</p>`;
    }
  })
  .join('');
---

<Layout 
  title={`${article.title} - Blog TechStore Pro`}
  description={`${article.excerpt} ⏱️ ${article.readTime} min lectura | Por ${article.author} | ${formatDate(article.publishDate)}`}
  keywords={`${article.tags.join(', ')}, ${article.category}, tecnología, ${article.author}`}
  image={article.image}
  url={`https://mi-ecommerce.com/articulos/${article.slug}`}
  type="article"
  author={article.author}
  publishedTime={article.publishDate}
  modifiedTime={article.publishDate}
>
  <Header />
  <main class="article-page">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="/">Inicio</a>
        <span class="separator">›</span>
        <a href="/articulos">Blog</a>
        <span class="separator">›</span>
        <a href={`/articulos?category=${article.categorySlug}`}>{article.category}</a>
        <span class="separator">›</span>
        <span>{article.title}</span>
      </nav>

      <!-- Article Header -->
      <header class="article-header">
        <div class="article-meta">
          <span class="article-category">
            <i class="fas fa-tag"></i>
            <a href={`/articulos?category=${article.categorySlug}`}>
              {article.category}
            </a>
          </span>
          <span class="article-date">
            <i class="fas fa-calendar"></i>
            {formatDate(article.publishDate)}
          </span>
          <span class="article-read-time">
            <i class="fas fa-clock"></i>
            {article.readTime} minutos de lectura
          </span>
        </div>

        <h1 class="article-title">{article.title}</h1>
        
        <div class="article-author-section">
          <div class="author-info">
            <img 
              src={`https://ui-avatars.com/api/?name=${encodeURIComponent(article.author)}&background=2563EB&color=fff&size=64&rounded=true`}
              alt={article.author}
              class="author-avatar"
            />
            <div class="author-details">
              <h3 class="author-name">{article.author}</h3>
              <p class="author-bio">Editor especializado en tecnología</p>
            </div>
          </div>
          
          <div class="social-share">
            <span class="share-label">Compartir:</span>
            <div class="social-buttons">
              <button class="social-btn whatsapp" onclick={`shareWhatsApp('${article.title}')`}>
                <i class="fab fa-whatsapp"></i>
              </button>
              <button class="social-btn facebook" onclick={`shareFacebook('${article.title}')`}>
                <i class="fab fa-facebook-f"></i>
              </button>
              <button class="social-btn twitter" onclick={`shareTwitter('${article.title}')`}>
                <i class="fab fa-twitter"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="article-image">
          <img 
            src={article.image} 
            alt={article.title}
            loading="eager"
          />
        </div>
      </header>

      <!-- Article Content -->
      <div class="article-layout">
        <article class="article-content">
          <div class="article-excerpt">
            {article.excerpt}
          </div>
          
          <div class="article-body" set:html={contentHTML}></div>
          
          <div class="article-tags">
            <h4>Etiquetas:</h4>
            <div class="tags-list">
              {article.tags.map(tag => (
                <span class="tag">#{tag}</span>
              ))}
            </div>
          </div>
        </article>

        <!-- Sidebar -->
        <aside class="article-sidebar">
          <div class="sidebar-widget">
            <h3>Tabla de Contenidos</h3>
            <ul class="toc">
              <li><a href="#introduccion">Introducción</a></li>
              <li><a href="#desarrollo">Desarrollo Principal</a></li>
              <li><a href="#conclusion">Conclusión</a></li>
            </ul>
          </div>

          <div class="sidebar-widget">
            <h3>Artículos Populares</h3>
            <div class="popular-articles">
              {articlesData.slice(0, 3).map(popularArticle => (
                <a href={`/articulos/${popularArticle.slug}`} class="popular-article">
                  <img src={popularArticle.image} alt={popularArticle.title} />
                  <div class="popular-content">
                    <h4>{popularArticle.title}</h4>
                    <span class="popular-date">{formatDate(popularArticle.publishDate)}</span>
                  </div>
                </a>
              ))}
            </div>
          </div>

          <div class="sidebar-widget newsletter">
            <h3>Suscríbete al Newsletter</h3>
            <p>Recibe las últimas noticias de tecnología directamente en tu inbox.</p>
            <form class="newsletter-form">
              <input type="email" placeholder="tu@email.com" required />
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-envelope"></i>
                Suscribir
              </button>
            </form>
          </div>
        </aside>
      </div>

      <!-- Related Articles -->
      {relatedArticles.length > 0 && (
        <section class="related-articles">
          <h2>Artículos Relacionados</h2>
          <div class="related-grid">
            {relatedArticles.map(relatedArticle => (
              <article class="related-card">
                <a href={`/articulos/${relatedArticle.slug}`} class="related-link">
                  <img 
                    src={relatedArticle.image} 
                    alt={relatedArticle.title}
                    loading="lazy"
                  />
                  <div class="related-content">
                    <div class="related-meta">
                      <span class="related-category">{relatedArticle.category}</span>
                      <span class="related-date">{formatDate(relatedArticle.publishDate)}</span>
                    </div>
                    <h3>{relatedArticle.title}</h3>
                    <p>{relatedArticle.excerpt}</p>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </section>
      )}
    </div>
  </main>
  <Footer client:load />

  <!-- Schema.org Article Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": article.title,
    "description": article.excerpt,
    "image": article.image,
    "author": {
      "@type": "Person",
      "name": article.author
    },
    "publisher": {
      "@type": "Organization",
      "name": "TechStore Pro",
      "logo": {
        "@type": "ImageObject",
        "url": "https://mi-ecommerce.com/logo.png"
      }
    },
    "datePublished": article.publishDate,
    "dateModified": article.publishDate,
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `https://mi-ecommerce.com/articulos/${article.slug}`
    }
  }
  </script>
</Layout>

<style>
  .article-page {
    padding: var(--spacing-8) 0;
    background: var(--gray-50);
    min-height: 100vh;
  }

  .breadcrumb {
    margin-bottom: var(--spacing-8);
  }

  .article-header {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-12);
    margin-bottom: var(--spacing-12);
    box-shadow: var(--shadow-lg);
  }

  .article-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-6);
    margin-bottom: var(--spacing-8);
    font-size: var(--font-size-sm);
    color: var(--gray-500);
  }

  .article-meta span {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  .article-category a {
    color: var(--primary-color);
    font-weight: 600;
    text-decoration: none;
  }

  .article-category a:hover {
    text-decoration: underline;
  }

  .article-title {
    font-size: var(--font-size-4xl);
    font-weight: 700;
    color: var(--gray-900);
    line-height: 1.1;
    margin: 0 0 var(--spacing-10) 0;
  }

  .article-author-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-8) 0;
    border-top: 1px solid var(--gray-200);
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: var(--spacing-10);
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
  }

  .author-avatar {
    border-radius: 50%;
    border: 3px solid var(--gray-200);
  }

  .author-details {
    display: flex;
    flex-direction: column;
  }

  .author-name {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
  }

  .author-bio {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    margin: 0;
  }

  .social-share {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
  }

  .share-label {
    font-weight: 500;
    color: var(--gray-700);
    font-size: var(--font-size-sm);
  }

  .social-buttons {
    display: flex;
    gap: var(--spacing-2);
  }

  .social-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--font-size-lg);
    color: white;
    transition: all var(--transition-fast);
  }

  .social-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .social-btn.whatsapp {
    background: #25D366;
  }

  .social-btn.facebook {
    background: #1877F2;
  }

  .social-btn.twitter {
    background: #1DA1F2;
  }

  .article-image {
    width: 100%;
    height: 400px;
    border-radius: var(--border-radius-lg);
    overflow: hidden;
  }

  .article-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .article-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--spacing-12);
    margin-bottom: var(--spacing-20);
  }

  .article-content {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-12);
    box-shadow: var(--shadow-lg);
  }

  .article-excerpt {
    font-size: var(--font-size-xl);
    line-height: 1.7;
    color: var(--gray-700);
    font-weight: 500;
    margin-bottom: var(--spacing-10);
    padding-bottom: var(--spacing-8);
    border-bottom: 1px solid var(--gray-200);
  }

  .article-body {
    line-height: 1.8;
    color: var(--gray-800);
    margin-bottom: var(--spacing-10);
  }

  .article-body :global(h2) {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin: var(--spacing-12) 0 var(--spacing-6) 0;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: var(--spacing-2);
  }

  .article-body :global(h3) {
    font-size: var(--font-size-xl);
    font-weight: 600;
    color: var(--gray-900);
    margin: var(--spacing-10) 0 var(--spacing-4) 0;
  }

  .article-body :global(p) {
    margin-bottom: var(--spacing-6);
    font-size: var(--font-size-lg);
  }

  .article-body :global(strong) {
    color: var(--gray-900);
    font-weight: 600;
  }

  .article-tags {
    border-top: 1px solid var(--gray-200);
    padding-top: var(--spacing-8);
  }

  .article-tags h4 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 var(--spacing-4) 0;
  }

  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-3);
  }

  .tag {
    background: var(--primary-color);
    color: white;
    font-size: var(--font-size-sm);
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: var(--border-radius-full);
    font-weight: 500;
  }

  .article-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-8);
  }

  .sidebar-widget {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-8);
    box-shadow: var(--shadow-lg);
  }

  .sidebar-widget h3 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 var(--spacing-6) 0;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: var(--spacing-2);
  }

  .toc {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc li {
    margin-bottom: var(--spacing-3);
  }

  .toc a {
    color: var(--gray-700);
    text-decoration: none;
    font-size: var(--font-size-sm);
    padding: var(--spacing-2) 0;
    display: block;
    border-left: 3px solid transparent;
    padding-left: var(--spacing-4);
    transition: all var(--transition-fast);
  }

  .toc a:hover {
    color: var(--primary-color);
    border-left-color: var(--primary-color);
    text-decoration: none;
    background: var(--gray-50);
  }

  .popular-articles {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4);
  }

  .popular-article {
    display: flex;
    gap: var(--spacing-3);
    padding: var(--spacing-3);
    border-radius: var(--border-radius);
    text-decoration: none;
    color: inherit;
    transition: background-color var(--transition-fast);
  }

  .popular-article:hover {
    background: var(--gray-50);
    text-decoration: none;
    color: inherit;
  }

  .popular-article img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--border-radius);
    flex-shrink: 0;
  }

  .popular-content h4 {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 var(--spacing-1) 0;
    line-height: 1.3;
  }

  .popular-date {
    font-size: var(--font-size-xs);
    color: var(--gray-500);
  }

  .newsletter {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)) !important;
    color: white;
  }

  .newsletter h3 {
    color: white;
    border-bottom-color: rgba(255, 255, 255, 0.3);
  }

  .newsletter p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: var(--spacing-6);
  }

  .newsletter-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .newsletter-form input {
    padding: var(--spacing-3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--border-radius);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: var(--font-size-sm);
  }

  .newsletter-form input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .newsletter-form input:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.6);
    background: rgba(255, 255, 255, 0.15);
  }

  .newsletter-form .btn {
    background: white;
    color: var(--primary-color);
    border: none;
  }

  .newsletter-form .btn:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateY(-1px);
  }

  .related-articles {
    background: white;
    border-radius: var(--border-radius-xl);
    padding: var(--spacing-12);
    box-shadow: var(--shadow-lg);
  }

  .related-articles h2 {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin: 0 0 var(--spacing-10) 0;
    text-align: center;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-8);
  }

  .related-card {
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    transition: all var(--transition-normal);
  }

  .related-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .related-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .related-link:hover {
    text-decoration: none;
    color: inherit;
  }

  .related-card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }

  .related-content {
    padding: var(--spacing-6);
  }

  .related-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-3);
    font-size: var(--font-size-xs);
  }

  .related-category {
    color: var(--primary-color);
    font-weight: 600;
  }

  .related-date {
    color: var(--gray-500);
  }

  .related-card h3 {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 var(--spacing-3) 0;
    line-height: 1.3;
  }

  .related-card p {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    margin: 0;
    line-height: 1.5;
  }

  @media (max-width: 768px) {
    .article-title {
      font-size: var(--font-size-3xl);
    }

    .article-author-section {
      flex-direction: column;
      gap: var(--spacing-6);
      align-items: flex-start;
    }

    .article-image {
      height: 250px;
    }

    .article-layout {
      grid-template-columns: 1fr;
      gap: var(--spacing-8);
    }

    .article-content {
      padding: var(--spacing-8);
    }

    .article-excerpt {
      font-size: var(--font-size-lg);
    }

    .article-body :global(p) {
      font-size: var(--font-size-base);
    }

    .related-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-6);
    }

    .social-share {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  function shareWhatsApp(title) {
    const url = window.location.href;
    const message = `¡Interesante artículo! "${title}"`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message + ' ' + url)}`;
    window.open(whatsappUrl, '_blank');
  }

  function shareFacebook(title) {
    const url = window.location.href;
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    window.open(facebookUrl, '_blank');
  }

  function shareTwitter(title) {
    const url = window.location.href;
    const message = `"${title}"`;
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(url)}`;
    window.open(twitterUrl, '_blank');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const newsletterForm = document.querySelector('.newsletter-form');
    
    newsletterForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = e.target.querySelector('input[type="email"]').value;
      alert(`¡Gracias por suscribirte con el email: ${email}!`);
      e.target.reset();
    });
  });
</script>